{% extends 'web/base.html' %}
{% from 'web/macros/autocomplete-input.html' import autocomplete_input_become_guru %}

{% block main_header %}
<header class="bar bar-nav">
  <h1 class="title">Become a Guru</h1>
</header>
{% endblock %}

{% block main_content %}
<div class="content should-hide-message-bar">
  <ul class="table-view">
    <li class="table-view-cell media ignore-table-view-margin">
        <div class="media-body">
          Add Photo
          <img id='guru-profile-photo' class="media-object pull-right table-view-mini-face hidden"/>
        </div>
        <a id='upload-photo-link' class="btn btn-primary">Upload</a>
        <input id='upload-photo' style='display:none;' type='file'/>
    </li>
    <li class='table-view-cell overflow-visible'>
      Add courses
      <input id='become-guru-course-input' type="text" placeholder="CS10" class='no-bottom-margin' />
      <a id='add-course-btn' style='top:65px;' class="btn btn-primary pull-right">Add</a>
    </li>
    <li class="table-view-cell media ignore-table-view-margin hidden" id='add-courses-container'>
    </li>
    <li class='table-view-cell ignore-table-view-margin'>
      Introduction
      <textarea data-user-id='{{user.id}}' id='tutor-introduction' placeholder='Include a short introduction of yourself!'rows="5"></textarea>
    </li>
  </ul>
  <a href='#' id='submit-guru-application' data-transition='fade' data-user-id='{{user.id}}'class='btn btn-block btn-positive'>Submit</a>

  <script>
    $('#upload-photo-link').on('click', function(e) {
      e.preventDefault();
      $('#upload-photo').trigger('click');
    });

    $('#submit-guru-application').on('click', function(){
        var user_id = ($('#submit-guru-application').data().userId).toString();
        
        payload = JSON.stringify({
            action: 'become-guru',
            tutor_introduction:$('#tutor-introduction').val()
        });

        $.ajax({
            url: '/api/v1/users/' + user_id,
            type: 'PUT',
            contentType: 'application/json',
            data: payload,
            success: function(request){
                window.PUSH({
                    transition : "fade",
                    url : "/m/guru/"
                });
            },
            error: function (request) {
                alert(request.responseJSON['errors']);
            }
        });

      });

    $('#upload-photo:hidden').change(function(){
      var file = this.files[0];
      //TODO Cam: Can we validate this properly?
      if (file.type != 'image/png' && file.type != 'image/jpg' && file.type != 'image/gif' && file.type != 'image/jpeg' ) {
        alert("File doesnt match png, jpg, or gif");
      } else {
        readURL(this);
        var formData = new FormData();
        formData.append('file', file);
        $.ajax({
          url:'/update-profile/',
          type: 'POST',
          data: formData,
          cache: false,
          contentType: false,
          processData: false
        });
      }
    });

    function readURL(input) {
      if (input.files && input.files[0]) {
        var reader = new FileReader();

        reader.onload = function (e) {
          $('#upload-photo-link').hide();
          $('#guru-profile-photo').show();
          console.log(e.target.result);
          $('#guru-profile-photo').attr('src', e.target.result);
        };

        reader.readAsDataURL(input.files[0]);
      }
    }
  </script>

  {{autocomplete_input_become_guru("become-guru-course-input", "add-courses-container")}}

</div>
{% endblock %}

    
