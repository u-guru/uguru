{% extends 'base.html' %}

{% block header %}
    <link href="/static/css/admin.css" rel="stylesheet">
{% endblock %}

{% block content %}

<ul style="margin:auto;float:center" class="nav nav-tabs">
  <li class="active"><a href="#tutors" data-toggle="tab">Tutors</a></li>
  <li><a href="#students" data-toggle="tab">Students</a></li>
  <li><a href="#analytics" data-toggle="tab">Analytics</a></li>
  <li><a href="#requests" data-toggle="tab">Requests</a></li>
  <li><a href="#conversations" data-toggle="tab">Conversations</a></li>
  <!-- <li><a href="#notifications" data-toggle="tab">Notifications</a></li> -->
  <li><a href="#payments" data-toggle="tab"> Payments</a></li>
  <li><a href="#ratings" data-toggle="tab"> Ratings</a></li>
  <li><a href="#bank-transfers" data-toggle="tab"> Bank Transfers</a></li>
  <li><a href="#unverified_tutors" data-toggle="tab"> Unverified Tutors</a></li>
  <li><a href="#unfinished-accounts" data-toggle="tab"> Unfinished Accounts</a></li>
  <li><a href="#texts" data-toggle="tab"> Texts </a></li>
</ul>

<div class="tab-content">

  <div class="tab-pane active" id="tutors">
    <div class="container">
        <div style="margin:20px; text-align:center" class="row">
            # Tutors: {{tutor_count}}
        </div>
        <div class="row-fluid">
            <table class="table table-striped">
                <tr class="info"> 
                    <td> Id </td>
                    <td> Name </td>
                    <td> Email </td>
                    <td> Time </td>
                    <td> Refer Code </td>
                    <td> Skills </td>
                    <td> What's missing profile </td>
                    <td> Num Convos</td>
                    <td> Last Active </td>
                </tr>
                {% for user in users %}
                        {% if user.verified_tutor and user.approved_by_admin %}
                        <tr> 
                            <td>  {{user.id}} </td>
                            <td> <a href="javascript:void(0)" class="login-user"> {{user.name}} </a> </td>
                            <td> {{user.email}} </td>
                            <td> {{pretty_dates[user.id]}} </td>
                            <td> {{user.referral_code}} </td>
                            <td> {{skills_dict[user.id]}}</td>
                            <td>
                                {% if user.profile and user.introduction and user.major%}
                                Complete
                                {% else %}
                                    {% if user.profile_url == '/static/img/default-photo.jpg' %}
                                    Profile, 
                                    {% endif %}
                                    {% if not user.tutor_introduction %}
                                    Introduction, 
                                    {% endif %}
                                    {% if not user.major %}
                                    Major
                                    {% endif %}
                                {% endif %}
                            </td>
                            <td>
                                {{user.mailbox.conversations|length}}
                            </td>
                            <td>
                                {{users_last_active[user]}}
                            </td>
                        </tr>
                        {% endif %}
                {% endfor %}
            </table>
        </div>
    </div>
  </div>

    <div class="tab-pane" id="unfinished-accounts">
        <div class="container">
            <div style="margin:20px; text-align:center" class="row">
                # Unfinished Accounts: {{unfinished_accounts|length}}
            </div>
            <div class="row-fluid">
                <table class="table table-striped">
                    <tr class="info"> 
                        <td> Id </td>
                        <td> Email </td>
                        <td> Referral? </td>
                    </tr>
                    {% for user in unfinished_accounts %}
                            <tr> 
                                <td>  {{user.id}} </td>
                                <td> {{user.email}} </td>
                                <td> {{user.referral_code}} </td>
                            </tr>
                    {% endfor %}
                </table>
            </div>
        </div>
      </div>

      <div class="tab-pane" id="texts">
        <div class="container">
            <div style="margin:20px; text-align:center" class="row">
                # Texts: {{texts|length}}
            </div>
            <div class="row-fluid">
                <table class="table table-striped">
                    <tr class="info"> 
                        <td> Id </td>
                        <td> Phone </td>
                        <td> Message </td>
                        <td> Status </td>
                    </tr>
                    {% for text in texts|reverse %}
                            <tr> 
                                <td>  {{text.id}} </td>
                                <td> {{text.to_phone}} </td>
                                <td> {{text.body}} </td>
                                <td> {{text.status}} </td>
                            </tr>
                    {% endfor %}
                </table>
            </div>
        </div>
      </div>

  <div class="tab-pane" id="unverified_tutors">
    <div class="container">
        <div style="margin:20px; text-align:center" class="row">
            # Unverified Tutors: {{unverified_tutor_count}}
        </div>
        <div class="row-fluid">
            <table class="table table-striped">
                <tr class="info"> 
                    <td> Id </td>
                    <td> Name </td>
                    <td> Email </td>
                    <td> Skills </td>
                    <td> What's missing profile </td>
                    <td> Qualifications </td>
                    <td> Approve </td>
                </tr>
                {% for user in users %}
                        {% if user.qualifications and not user.approved_by_admin %}
                        <tr> 
                            <td>  {{user.id}} </td>
                            <td> <a href="javascript:void(0)" class="login-user"> {{user.name}} </a> </td>
                            <td> {{user.email}} </td>
                            <td> {{skills_dict[user.id]}}</td>
                            <td>
                                {% if user.profile and user.introduction and user.major%}
                                Complete
                                {% else %}
                                    {% if user.profile_url == '/static/img/default-photo.jpg' %}
                                    Profile, 
                                    {% endif %}
                                    {% if not user.tutor_introduction %}
                                    Introduction, 
                                    {% endif %}
                                    {% if not user.major %}
                                    Major
                                    {% endif %}
                                {% endif %}
                            </td>
                            <td>
                            {{user.qualifications}}
                            </td>
                            <td>
                                <a href="javascript:void(0)" class="approve-tutor"><u>Approve</u></a>
                            </td>
                        </tr>
                        {% endif %}
                {% endfor %}
            </table>
        </div>
    </div>
  </div>

  <div class="tab-pane" id="students"> 
    <div class="tab-pane active" id="tutors">
        <div class="container">
            <div style="margin:20px; text-align:center" class="row">
            # Students: {{student_count}}
            </div>
            <div class="row-fluid">
                <table class="table table-striped">
                    <tr class="info"> 
                        <td> Id </td>
                        <td> Name </td>
                        <td> Email </td>
                        <td> Time </td>
                        <td> Referral Code </td>
                        <td> Last Active </td>
                    </tr>
                    {% for user in users %}
                            {% if not user.skills and not user.referral_code == 'guru' %}
                            <tr> 
                                <td>  {{user.id}} </td>
                                <td> <a href="javascript:void(0)" class="login-user"> {{user.name}} </a> </td>
                                <td> {{user.email}} </td>
                                <td> {{pretty_dates[user.id]}} </td>
                                <td>
                                    {{user.referral_code}}
                                </td>
                                <td>
                                {{users_last_active[user]}}
                                </td>
                            </tr>
                            {% endif %}
                    {% endfor %}
                </table>
            </div>
        </div>
      </div>
  </div>

  <div class="tab-pane" id="conversations"> 
    <div class="tab-pane active" id="tutors">
        <div class="container">
            <div class="row-fluid">
                <table class="table table-striped">
                    <tr class="info"> 
                        <td> Id </td>
                        <td> Requested Skill </td>
                        <td> Student </td>
                        <td> Tutor </td>
                        <td> Message Count </td>
                        <td> Last Message Time</td>
                    </tr>
                    {% for c in conversations %}
                            <tr> 
                                <td>  {{c['conversation'].id}} </td>
                                <td> {{c['skill-name']}}
                                <td> <a href="javascript:void(0)" class="view-student-message"> {{c['student'].name.split(" ")[0]}} </a> (id:<span>{{c['student'].id}}</span>)</td>
                                <td> <a href="javascript:void(0)" class="view-tutor-message"> {{c['tutor'].name.split(" ")[0]}} </a>(id:<span>{{c['tutor'].id}}</span>) </td>
                                <td> {{c['msg-count']}} </td>
                                <td> {{c['last-message-time']}} </td>
                            </tr>
                    {% endfor %}
                </table>
            </div>
        </div>
      </div>
  </div>

  <div class="tab-pane" id="analytics"> 
    <div class="tab-pane active" id="tutors">
        <div class="container">
            <div style="margin:20px; text-align:center" class="row">
            </div>
            <div class="row-fluid">
                <table class="table table-striped">
                    <tr class="info"> 
                        <td> Skill </td>
                        <td> Count </td>
                    </tr>
                    {% for row in skills_counter|reverse %}
                        <tr> 
                            <td>  {{row[0]}} </td>
                            <td>  {{row[1]}} </td>
                        </tr>
                    {% endfor %}
                </table>
            </div>
        </div>
      </div>
  </div>

  <div class="tab-pane" id="bank-transfers"> 
    <div class="tab-pane active" id="tutors">
        <div class="container">
            <div style="margin:20px; text-align:center" class="row">
            </div>
            <div class="row-fluid">
                <table class="table table-striped">
                    <tr class="info"> 
                        <td> Tutor </td>
                        <td> Bank Name </td>
                        <td> Time </td>
                        <td> Status </td>
                        <td> Amount </td>
                    </tr>
                    {% for transaction in transactions %}
                        <tr> 
                            <td>  {{transaction['tutor-name']}} (id:{{transaction['tutor-id']}})</td>
                            <td>  TODO </td>
                            <td>  {{transaction['time']}} </td>
                            <td>  TODO </td>
                            <td>  {{transaction['amount']}} </td>
                        </tr>
                    {% endfor %}
                </table>
            </div>
        </div>
      </div>
  </div>

  <div class="tab-pane" id="ratings"> 
    <div class="tab-pane active" id="tutors">
        <div class="container">
            <div style="margin:20px; text-align:center" class="row">
            </div>
            <div class="row-fluid">
                <table class="table table-striped">
                    <tr class="info"> 
                        <td> ID </td>
                        <td> Role </td>
                        <td> Class </td>
                        <td> Rating </td>
                        <td> Description</td>
                    </tr>
                    {% for rating in ratings|sort(attribute='time_created')|reverse %}
                        <tr> 
                            <td> {{rating.id}} </td>
                            <td> {{ratings_dict[rating]['student-name']}} (student) reviewing {{ratings_dict[rating]['tutor-name']}} (tutor)</td>
                            <td> {{ratings_dict[rating]['skill']}}</td>
                            <td> {{rating.tutor_rating}}</td>
                            <td> {{rating.tutor_rating_description}}</td>
                        </tr>
                        <tr> 
                            <td> {{rating.id}} </td>
                            <td> {{ratings_dict[rating]['tutor-name']}} (tutor) reviewing {{ratings_dict[rating]['student-name']}} (student)</td>
                            <td> {{ratings_dict[rating]['skill']}}</td>
                            <td> {{rating.student_rating}}</td>
                            <td> {{rating.student_rating_description}}</td>
                        </tr>
                    {% endfor %}
                </table>
            </div>
        </div>
      </div>
  </div>

  <!-- <div class="tab-pane" id="notifications"> 
    <div class="tab-pane active" id="tutors">
        <div class="container">
            <div style="margin:20px; text-align:center" class="row">
            </div>
            <div class="row-fluid">
                <table class="table table-striped">
                    <tr class="info"> 
                        <td> ID </td>
                        <td> Type </td>
                        <td> Request ID </td>
                        <td> Feed Message </td>
                    </tr>
                    {% set valid_tags = ['student-request-help', 'tutor-request-offer', 'tutor-accept-offer', 'student-incoming-offer'] %}
                        {% for n in notifications %}
                            {% if n.custom_tag in valid_tags %}
                            <tr> 
                                <td>  {{n.id}} </td>
                                <td>  {{n.custom_tag}} </td>
                                <td>  {{n.request_id}} </td>
                                <td>  {{n.feed_message[0:30]|safe}} </td>
                            </tr>
                            {% endif %}
                        {% endfor %}
                </table>
            </div>
        </div>
      </div>
  </div> -->

  <div class="tab-pane" id="payments"> 
    <div class="tab-pane active" id="tutors">
        <div class="container">
            <div style="margin:20px; text-align:center" class="row">
                # Payments: {{payments|length}} 
            </div>
            <div class="row-fluid">
                <table class="table table-striped">
                    <tr style="font-size:12px" class="info"> 
                        <td> ID </td>
                        <td> Time </td>
                        <td> Student </td>
                        <td> Tutor </td>
                        <td> Time Amount </td>
                        <td> Student Rate</td>
                        <td> Tutor Rate</td>
                        <td> Recurring? </td>
                        <td> Student Charge </td>
                        <td> Tutor Paid </td>
                        <td> Stripe Fees </td>
                        <td> Profit </td>
                    </tr>
                        {% for payment_dict in payments %}
                            <tr>
                                <td>  {{payment_dict['payment'].id}}</td> 
                                <td>  {{payment_dict['time_created']}}</td> 
                                <td>  {{payment_dict['student'].name.split(" ")[0]}} (id:{{payment_dict['student'].id}})</td>
                                <td>  
                                    {% if payment_dict['tutor'] %}
                                        {{payment_dict['tutor'].name.split(" ")[0]}} (id:{{payment_dict['tutor'].id}})
                                    {% else %}
                                        None
                                    {% endif %}
                                </td>
                                <td>
                                    {% if payment_dict['payment'].time_amount %}  
                                    {{payment_dict['payment'].time_amount}}hours 
                                    {% else %}
                                    None
                                    {% endif %}
                                </td>
                                <td>  ${{payment_dict['student-hourly']}}/hr</td>
                                <td>  ${{payment_dict['tutor-hourly']}}/hr</td>
                                <td>  {% if payment_dict['recurring'] %} Yes {%else%} First Time {% endif %}</td>
                                <td style="color:green">  +${{payment_dict['student-total']}}</td>
                                <td style="color:red">  -${{payment_dict['tutor-total']}}</td>
                                <td style="color:red">  
                                    -${{payment_dict['stripe-fees']}}
                                </td>
                                <td style="color:green"> +${{payment_dict['profit']}}</td>
                            </tr>
                        {% endfor %}
                    <tr style="font-size:14px;" class="info">
                        <td style="font-weight:bold;">
                            AVG
                        </td>
                        <td>
                        </td>
                        <td>
                        </td>
                        <td>
                        </td>
                        <td>
                        </td>
                        <td style="font-weight:bold;">
                        {% if payments|length > 0 %}
                           ${{payment_analytics['avg-student-rate']/(payments|length)}}/hr
                        {% endif %}
                        </td>
                        <td style="font-weight:bold;">
                           {% if payments|length > 0 %}
                            ${{payment_analytics['avg-tutor-rate']/(payments|length)}}/hr
                           {% endif %}
                        </td>
                        <td>
                            
                        </td>
                        <td style="font-weight:bold;">
                            {% if payments|length > 0 %}
                                ${{payment_analytics['avg-student-charge']/(payments|length
                                )}}
                            {% endif %}
                        </td>
                        <td style="font-weight:bold;">
                            {% if payments|length > 0 %}
                                ${{payment_analytics['avg-tutor-paid']/(payments|length)}}
                            {% endif %}

                        </td>
                        <td style="font-weight:bold;">
                            {% if payments|length > 0 %}
                            ${{payment_analytics['avg-stripe-fees']/(payments|length)}}
                            {% endif %}
                        </td>
                        <td style="font-weight:bold;">
                            {% if payments|length > 0 %}
                                ${{payment_analytics['avg-profit']/(payments|length)}}
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td>
                        </td>
                        <td>
                        </td>
                        <td>
                        </td>
                        <td>
                        </td>
                        <td>
                        </td>
                        <td>
                        </td>
                        <td style="font-weight:bold;text-align:right">
                           Cash Flow:
                        </td>
                        <td style="font-weight:bold; color:green;text-align:left">
                            ${{total_revenue}}
                        </td>
                        <td style="font-weight:bold;text-align:right">
                            Revenue:
                        </td>
                        <td style="font-weight:bold; text-align:left; color:green">
                            ${{payment_analytics['avg-stripe-fees'] + total_profit}}
                        </td>
                        <td style="font-weight:bold;text-align:right">
                            Profit: 
                        </td>
                        <td style="font-weight:bold; color:green;text-align:left">
                            ${{total_profit}}
                        </td>
                    </tr>
                </table>
            </div>
        </div>
      </div>
  </div>

  <div class="tab-pane" id="requests"> 
    <div class="tab-pane active" id="tutors">
        <div class="container">
            <div style="margin:20px; text-align:center" class="row">
                <span style="color:red">Red</span> = Canceled, <span style="color:green">Green</span> = Matched, <span style="color:#fcf8e3">Yellow</span> = Pending
            </div>
            <div style="margin:20px; text-align:center" class="row">
                # Requests: {{all_requests|length}} 
            </div>
            <div class="row-fluid">
                <table class="table table-striped">
                    <tr style="font-size:9px"class="info"> 
                        <td> ID </td>
                        <td> Student </td>
                        <td> Time Created </td>
                        <td> Class </td>
                        <td> # Students </td>
                        <td> Avail </td>
                        <td> Time </td>
                        <td> Hr Rate </td>
                        <td> Edited? </td>
                        <td> #Tutors Avail </td>
                        <td> #Tutors Seen Email </td>
                        <td> #Tutors Seen Notif </td>
                        <td> #Tutors Replied </td>
                        <td> Connected Tutor </td>
                        <td> Messaged? </td>
                        <td> Payment? </td>
                        <td> Rated? </td>
                        <td> We made </td>
                    </tr>
                    {% for request_dict in all_requests %}
                        {% if request_dict['student'].name %}
                        {% if request_dict['connected-tutor'] and request_dict['connected-tutor'] == request_dict['student']%}
                            {% set status = 'danger'%}
                        {% elif request_dict['connected-tutor'] %}
                            {% set status = 'success'%}
                        {% else %} 
                            {% set status = 'warning'%}
                        {% endif %}
                        <tr class="{{status}}"> 
                            <td>  
                                {{request_dict['request'].id}} 
                            </td>
                            <td>  
                                <a href="javascript:void(0)" class="login-student-request">{{request_dict['student'].name.split(" ")[0]}}</a> (id:<span>{{request_dict['request'].student_id}}</span>)
                            </td>
                            <td>  
                                {{request_dict['date']}}
                            </td>
                            <td> 
                                {{request_dict['skill_name']}} 
                            </td>
                            <td>  
                                {{request_dict['request'].num_students}} 
                            </td>
                            <td>  
                                {{request_dict['request'].available_time}} 
                            </td>
                            <td>  
                                {{request_dict['request'].time_estimate}} 
                            </td>
                            <td>  
                                ${{request_dict['request'].student_estimated_hour}}
                            </td>
                            <td>  
                                {% if request_dict['request'].last_updated %}
                                    {{request_dict['last-updated']}}
                                {% endif %}
                            </td>
                            <td>  
                                {{request_dict['request'].requested_tutors|length}} 
                            </td>
                            <td>  
                                {{request_dict['emails-seen']}} 
                            </td>
                            <td>  
                                {{request_dict['total_seen']}} 
                            </td>
                            <td>  
                                {{(request_dict['request'].committed_tutors|length - 1)}} 
                            </td>
                            <td>  
                                {% if request_dict['connected-tutor'] %}
                                    <a href="javascript:void(0)" class="login-tutor-request"> {{request_dict['connected-tutor'].name.split(" ")[0]}}</a> (id: <span> {{request_dict['connected-tutor'].id}}</span>)
                                {% else %}
                                    None
                                {% endif %}
                            </td>
                            <td>
                                {% if request_dict['message-length'] > 0 %}
                                Yes
                                {% else %}
                                No
                                {% endif %}
                            </td>
                            <td>
                                {% if request_dict['payment'] %}
                                Yes
                                {% else %}
                                No
                                {% endif %}
                            </td>
                            <td>
                                {% if request_dict['pending-ratings'] >= 0 or request_dict['pending-ratings'] < 3%}
                                    {% if request_dict['pending-ratings'] == 2 %}
                                    Neither
                                    {% elif request_dict['pending-ratings'] == 1 %}
                                        {% if request_dict['student'].pending_ratings %}
                                            only {{request_dict['connected-tutor'].name.split(" ")[0]}} has
                                        {% else %}
                                        only {{request_dict['student'].name.split(" ")[0]}} has
                                        {% endif %}
                                    {% else %}
                                    Both
                                    {% endif %}
                                {% endif%}
                            </td>
                            <td>
                                {% if request_dict['payment'] %}
                                    ${{request_dict['payment']}}
                                {% endif %}
                            </td>
                        </tr>
                        {% endif %}
                    {% endfor %}
                </table>
            </div>
        </div>
      </div>
  </div>
  <div style="text-align:center;color:black" class="row">
    <u><a href="/logout-admin/">Log out of admin</a></u>
  </div>


</div>

{% endblock %}

{% block footer_scripts %}
    <script src="/static/js/admin.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
    <script src="/static/js/typeahead.js"></script>
{% endblock %}