{% extends 'new_admin/base.html' %}

{% block header_scripts %}
<link href="/static/new_admin/plugins/datatables/dataTables.bootstrap.css" rel="stylesheet" type="text/css" />
<link href="/static/new_admin/plugins/fullcalendar/fullcalendar.min.css" rel="stylesheet" type="text/css" />
<link href="/static/new_admin/plugins/fullcalendar/fullcalendar.print.css" rel="stylesheet" type="text/css" media='print' />
<link href="/static/new_admin/plugins/datepicker/datepicker3.css" rel="stylesheet" type="text/css" />
{% endblock %}

{% block content %}
 <!-- Content Wrapper. Contains page content -->
      <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <section class="content-header">
          <h1>
            Team Action Items<br>
          </h1>
          <ol class="breadcrumb">
            <li><a href="/new_admin/"><i class="fa fa-dashboard"></i> Home </a></li>
            <li>Team</li>
            <li>Action Items</li>
          </ol>
        </section>
        <!-- Test Calendar -->
        <!-- Main content -->
        <section class="content">
          <div class="row">
            <div class="col-md-3">
              <div class="box box-solid">
                <div class="box-header with-border">
                  <h4 class="box-title">Team Calendars</h4>
                </div>
                <div class="box-body">
                  <!-- the events -->
                  <div id='external-events'>
                    <div class="container">
                      <div style="display:inline-block; width:150px;"class='external-event bg-green'>Uguru Master</div
                      >
                    </div>
                  </div>
                </div><!-- /.box-body -->
              </div><!-- /. box -->
            </div><!-- /.col -->
            <div class="col-md-9">
              <div class="box box-primary">
                <div class="box-body no-padding">
                  <!-- THE CALENDAR -->
                  <div id="calendar"></div>
                </div><!-- /.box-body -->
              </div><!-- /. box -->
            </div><!-- /.col -->
          </div><!-- /.row -->

          <div class='row'>
            <div class='col-xs-12 col-md-4'>
               <div class="box-body no-padding">
                  <!--The calendar -->
                  <div id="calendar-ben" style="width: 100%"></div>
               </div><!-- /.box-body -->
            </div>
          </div>
        </section><!-- /.content -->
      </div><!-- /.content-wrapper -->

    <!-- Add Possible Trello to do list for later-->

    <!-- Calendar Ends Here -->
    <!-- Main content -->
{% endblock %}

{% block footer_scripts %}
<script src="http://code.jquery.com/ui/1.11.2/jquery-ui.min.js" type="text/javascript"></script>
<script src="/static/new_admin/plugins/datatables/jquery.dataTables.js" type="text/javascript"></script>
<script src="/static/new_admin/plugins/datatables/dataTables.bootstrap.js" type="text/javascript"></script>
<script src="/static/js/new_admin/tables.js" type="text/javascript"></script>

    <!-- fullCalendar 2.2.5 -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.7.0/moment.min.js" type="text/javascript"></script>
    <script src="/static/new_admin/plugins/fullcalendar/fullcalendar.min.js" type="text/javascript"></script>

<script>
    TRELLO_API_KEY = '5c2c46b0d7987a904b459330e2edd41a';
    all_trello_list_id_objs = [];
    {% if session.get('user') and session['user']['name'] %}
      var first_name = "{{session['user']['name'].split(" ")[0]|title}}";
    {% else %}
      var first_name = "guest account";
    {% endif %}
    //3. Check --> Post to trello
    //4. Visuals: Alignment + collapsable + photos

    $(document).ready(function() {
      $('section').on('click', '.todo-info-icon',function() {
        description_p_elem = $(this).parent().siblings('p')[0];
        if (description_p_elem) {
          if ($(description_p_elem).is(':visible')) {
            $(description_p_elem).hide();
          } else {
            $(description_p_elem).show();
          }
        }
      });

       $("#calendar-ben").datepicker();

      var get_all_boards = function() {
        $.ajax({
            url: "https://api.trello.com/1/boards/8zend7RA?lists=open&list_fields=name&fields=name,desc&key=" + TRELLO_API_KEY,
            type: "GET",
            success: function(board){
              all_trello_list_id_objs = board.lists;
              process_list_objs(all_trello_list_id_objs);
            }
        });
      }

      var process_list_objs = function(list_objs) {
        if (!list_objs) {
          return;
        }
        for (var i = 0; i < list_objs.length; i ++) {
          get_one_list_item(list_objs[i]);
        }
      }

      var get_one_list_item = function(list_obj) {
        $.ajax({
            url: "https://api.trello.com/1/lists/" +list_obj.id + "?fields=name&cards=open&card_fields=name,labels,desc&key=" + TRELLO_API_KEY,
            type: "GET",
            success: function(list){
              list_obj.cards = list.cards;
              create_trello_list(list_obj);
            }
        });
      }

      var create_trello_list = function(list_obj) {
        user_name = list_obj.name.split(' ')[0];
        list_header = "<ul class='todo-list'><li><h5 class='box-title'><i class='ion ion-clipboard'></i> &nbsp;&nbsp;" + list_obj.name + "'s List</h5><img src='/static/img/admin/" + user_name.toLowerCase() + ".png' style='float: right;width: 25px;height: 25px;border-radius: 50%;margin-right: 10px;margin-top: -30px;'class='user-image' alt='User Image'></li>"

        list_body = "";
        for (var i = 0; i < list_obj.cards.length; i ++ ) {
          card = list_obj.cards[i];
          list_body += process_list_card_body(card);
        }
        list_footer = '</ul><br><br>'
        new_elem = $(list_header + list_body + list_footer);
        todo_list_instantiation(new_elem);
        if (list_obj.name.indexOf(first_name) !== -1) {
          $('#my-todo-list').append(new_elem);
        } else {
          $('#todo-lists').append(new_elem);
        }


      }

      var process_list_card_body = function(card) {
        list_body = "";

        //process card name
        list_body += process_list_card_header(card.name);

        //process list body labels
        labels = card.labels;
        if (labels && labels.length > 0) {
          list_body += process_list_card_labels(labels);
        }

        // check if description exists
        desc = card.desc;
        if (desc && desc.length > 0) {
          list_body += '<p style="display:none;padding-left:40px;" class="padding margin todo-description"><u>Description</u><br>' + desc + '</p>'
        }

        //process list_body_footer
        list_body += process_list_card_footer();

        return list_body;
      }

      var process_list_card_footer = function() {
        return "<div class='tools'><i class='todo-info-icon fa fa-info'></i></div></li>";
      }

      var process_list_card_header = function (card_name) {
        return "<li><span class='handle'><i class='fa fa-ellipsis-v'>&nbsp;</i><i class='fa fa-ellipsis-v'></i></span><input type='checkbox' value='' name=''/><span class='text' style='display:initial !important;'>" + card_name + "</span>";
      }

      var process_list_card_labels = function(labels) {
        list_body += '<li><input type="checkbox" value="" name=""/><span class="text">' + card.name + '</span>'
        label_str = "";
        for (var i = 0; i < labels.length; i ++) {
          label = labels[i];
          label_name = label.name;

          //if indexOf is == -1
          if (label.name.indexOf(':') !== -1) {
            label_str += '<small class="label" style="text-shadow: 0 0 5px rgba(0,0,0,.2),0 0 2px #000; font-size:10.5; background-color:'+ trello_color_map[label.color] + ';"><i class="fa fa-clock-o"></i>&nbsp;' + label_name.split(':')[1] + '</small>'
          }
          else {
            label_str += '<small class="label" style="font-size:10.5px;text-shadow: 0 0 5px rgba(0,0,0,.2),0 0 2px #000; background-color:'+ trello_color_map[label.color] + ';">' + label_name + '</small>'
          }
        }
        return label_str;
      }

      var todo_list_instantiation = function(elem) {
        elem.todolist({
          onCheck: function (ele) {
            console.log("The element has been checked")
          },
          onUncheck: function (ele) {
            console.log("The element has been unchecked")
          }
        });

        $(".todo-list").sortable({
          placeholder: "sort-highlight",
          handle: ".handle",
          forcePlaceholderSize: true,
          zIndex: 999999
        });
      }

      get_all_boards();

    } );

    trello_color_map = {
      orange: '#ff9f1a',
      green: '#70b500',
      yellow: '#F2D604',
      red: '#eb5a46',
      blue: '#0079bf',
      purple: '#c377e0'
    };

    /* initialize the external events
     -----------------------------------------------------------------*/
    function ini_events(ele) {
        ele.each(function () {

            // create an Event Object (http://arshaw.com/fullcalendar/docs/event_data/Event_Object/)
            // it doesn't need to have a start or end
            var eventObject = {
                title: $.trim($(this).text()) // use the element's text as the event title
            };

            // store the Event Object in the DOM element so we can get to it later
            $(this).data('eventObject', eventObject);

            // make the event draggable using jQuery UI
            $(this).draggable({
                zIndex: 1070,
                revert: true, // will cause the event to go back to its
                revertDuration: 0  //  original position after the drag
            });

        });
    }
    ini_events($('#external-events div.external-event'));

    /* initialize the calendar
     -----------------------------------------------------------------*/
    //Date for the calendar events (dummy data)
    var date = new Date();
    var d = date.getDate(),
            m = date.getMonth(),
            y = date.getFullYear();
    $('#calendar').fullCalendar({
        header: {
            left: 'prev,next today',
            center: 'title',
            right: 'month,agendaWeek,agendaDay'
        },
        buttonText: {
            today: 'today',
            month: 'month',
            week: 'week',
            day: 'day'
        },
        //Random default events
        events: [
            {
                title: 'Teem Meeting',
                start: new Date(y, m, d, 15, 45),
                allDay: false,
                backgroundColor: "#0073b7", //Blue
                borderColor: "#0073b7" //Blue
            }
        ],
        editable: true,
        droppable: true, // this allows things to be dropped onto the calendar !!!
        drop: function (date, allDay) { // this function is called when something is dropped

            // retrieve the dropped element's stored Event Object
            var originalEventObject = $(this).data('eventObject');

            // we need to copy it, so that multiple events don't have a reference to the same object
            var copiedEventObject = $.extend({}, originalEventObject);

            // assign it the date that was reported
            copiedEventObject.start = date;
            copiedEventObject.allDay = allDay;
            copiedEventObject.backgroundColor = $(this).css("background-color");
            copiedEventObject.borderColor = $(this).css("border-color");

            // render the event on the calendar
            // the last `true` argument determines if the event "sticks" (http://arshaw.com/fullcalendar/docs/event_rendering/renderEvent/)
            $('#calendar').fullCalendar('renderEvent', copiedEventObject, true);

            // is the "remove after drop" checkbox checked?
            if ($('#drop-remove').is(':checked')) {
                // if so, remove the element from the "Draggable Events" list
                $(this).remove();
            }

        }


    });



    /* ADDING EVENTS */
    var currColor = "#3c8dbc"; //Red by default
    //Color chooser button
    var colorChooser = $("#color-chooser-btn");
    $("#color-chooser > li > a").click(function (e) {
        e.preventDefault();
        //Save color
        currColor = $(this).css("color");
        //Add color effect to button
        $('#add-new-event').css({"background-color": currColor, "border-color": currColor});
    });
    $("#add-new-event").click(function (e) {
        e.preventDefault();
        //Get value and make sure it is not null
        var val = $("#new-event").val();
        if (val.length == 0) {
            return;
        }

        //Create events
        var event = $("<div />");
        event.css({"background-color": currColor, "border-color": currColor, "color": "#fff"}).addClass("external-event");
        event.html(val);
        $('#external-events').prepend(event);

        //Add draggable funtionality
        ini_events(event);

        //Remove event from text input
        $("#new-event").val("");
    });
</script>

{% endblock %}