{% extends 'new_admin/base.html' %}

{% block header_scripts %}
<link href="/static/new_admin/plugins/datatables/dataTables.bootstrap.css" rel="stylesheet" type="text/css" />
{% endblock %}

{% block content %}
 <!-- Content Wrapper. Contains page content -->
      <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <section class="content-header">
          <h1>
            View Campaigns<br>
            <small>This is where we can view campaign results & status</small>
          </h1>
          <ol class="breadcrumb">
            <li><a href="/new_admin/"><i class="fa fa-dashboard"></i> Home </a></li>
            <li class="active">Campaigns</li>
          </ol>
        </section>

        <!-- Main content -->
        <section class="content">

          <div class="row">
            <div class="col-xs-12">
              <div class="box">
                <div class="box-header">
                  <h3 class="box-title">Let the fun & games begin</h3>
                </div><!-- /.box-header -->
                <div class="box-body table-responsive no-padding">
                  <table class="table table-hover bootstrap-database" id="view-campaigns">

                  </table>
                </div><!-- /.box-body -->
                <div class="box-footer">
                    <button type="submit" id="cancel-scheduled-email" class="btn btn-danger">Cancel All</button>
                </div>
              </div><!-- /.box -->
            </div>
          </div>

        </section><!-- /.content -->
      </div><!-- /.content-wrapper -->
{% endblock %}

{% block footer_scripts %}
<script src="/static/new_admin/plugins/datatables/jquery.dataTables.js" type="text/javascript"></script>
<script src="/static/new_admin/plugins/datatables/dataTables.bootstrap.js" type="text/javascript"></script>
<script src="/static/js/new_admin/mandrill.js" type="text/javascript"></script>
<script src="/static/js/new_admin/tables.js" type="text/javascript"></script>

<script>
    batch_results_dict = {};
    $(document).ready(function() {

        var cancel_all_scheduled = function() {
          $('tbody tr').each(
            function(index, element) {
              var message_id = $(this).children('td:first').text().trim();
            $.ajax({
                url: "https://mandrillapp.com/api/1.0/messages/cancel-scheduled.json",
                type: "POST",
                contentType: 'application/json',
                data: JSON.stringify({key: MANDRILL_API_KEY, id:message_id}),
                success: function(scheduled_msgs){
                  // window.location.replace('/admin/campaigns/scheduled/');
                },
                error: function(error) {
                  console.log(JSON.stringify(error));
                }
              });
            })

        }

        // $.ajax({
        //     url: "https://mandrillapp.com/api/1.0/messages/list-scheduled.json",
        //     type: "POST",
        //     contentType: 'application/json',
        //     data: JSON.stringify({key: MANDRILL_API_KEY}),
        //     success: function(scheduled_msgs){
        //         parse_scheduled_messages(scheduled_msgs);
        //         var new_table = create_table(['Message Id', 'Time Created', 'Scheduled Time','Sender', 'Receiver', 'Subject'], scheduled_msgs,
        //             {
        //                 "_id":true,
        //                 "created_at": true,
        //                 "send_at":true,
        //                 "from_email": true,
        //                 "to":true,
        //                 "subject": true,
        //                 }
        //         );

        //         $('#view-campaigns').append(new_table);
        //         $('#view-campaigns').DataTable({
        //             "bInfo": false,
        //             "bPaginate": false,
        //             "bLengthChange": false,
        //             "bFilter": false,
        //             "aaSorting": [[1, 'desc']]
        //         });

        //         $('#cancel-scheduled-email').click(function() {
        //           if (confirm('are you sure?')) {
        //             cancel_all_scheduled();
        //           }
        //         })
        //     },
        //     error: function (request) {
        //         alert('Incorrect username or password, please try again');
        //     }
        // });

        // var parse_scheduled_messages = function(messages) {

        // }

        var getAllBatchStatistics = function() {
            default_batch_length  = 100;
            current_batch_length = get_batch_length();
            results = [];

            if (!current_batch_length) {
                current_batch_length = default_batch_length;
            }

            for (var i = 1; i < (current_batch_length + 1); i ++) {
                if (i < 13) {
                    all_emails = getBatchEmails(null, (i - 1));
                }
                else {
                    //query mandrill for batch 13 or until there is no more
                }
            }
        }

        var query_mandrill_by_metadata = function(batch_id) {

        }

        var get_batch_length = function() {
            return null;
        }

        var getBatchEmails = function(batch_name, batch_id) {
          //if old batch id
          if (!batch_name) {
            old_batch_dict = batch_filter[(batch_id + 1) + ''];
            searchMandrillMessage(null, old_batch_dict.date_from, old_batch_dict.date_to, old_batch_dict.start, old_batch_dict.end, processOldBatchResults, batch_id);
          }
        }

        var processOldBatchResults = function(results, batch_id) {
          next_hundred_emails = [];
          batch_results_dict[(batch_id + 1) + ''] = {
            emails: results
          }
          if (Object.keys(batch_results_dict).length === 12) {
            var batch_results_keys = Object.keys(batch_results_dict)
            var sample_email_arr_batch = [];
            for (var i = 0; i < batch_results_keys.length; i ++) {
              email = batch_results_dict[(i + 1) + ''].emails[0];
              sample_email_arr_batch.push(email);
            }
            check_scheduled_emails_from_batch(sample_email_arr_batch);
          }
          return next_hundred_emails;
        }

        var create_scheduled_batch_table = function(results_batch_ids, num_batches) {

            header_columns = ['Batch Number', 'Subject', 'Time Scheduled','Time Created', 'Size', 'Cancel?'];
            unique_opens = 0;
            unique_clicks = 0;
            batches = [];
            for (var i = 0; i < num_batches; i ++) {
                batch_num = results_batch_ids[i];
                result_emails = batch_results_dict[batch_num + ''].scheduled_emails;
                unique_opens = 0;
                unique_clicks = 0;
                for (var j = 0; j < result_emails.length; j++) {
                    current_email = result_emails[j];
                    if (current_email["opens"] > 0) {
                        unique_opens += 1
                    }

                    if (current_email["clicks"] > 0) {
                        unique_clicks += 1
                    }
                }
                batches.push({
                    "batch_num": batch_num,
                    "subject": result_emails[0].subject,
                    "send_at": new Date(result_emails[0].send_at).toJSON().toString(),
                    "created_at": new Date(result_emails[0].created_at).toJSON().toString(),
                    "batch_size": batch_results_dict[batch_num + ''].emails.length,
                    "cancel": "<a href'#' class='cancel-batch-schedule'>cancel</a>"
                })
            }
            var new_table = create_table(header_columns, batches,
                    {
                        "batch_num":true,
                        "subject": true,
                        "send_at": true,
                        "created_at": true,
                        "batch_size": true,
                        "cancel": true
                    }
                );

                $('#view-campaigns').append(new_table);
                $('#view-campaigns').DataTable({
                    "bInfo": false,
                    "bPaginate": false,
                    "bLengthChange": false,
                    "bFilter": false,
                    "aaSorting": [[2, 'desc']]
                });

        }

        //create function checks whether there is a scheduled batch to be
        // sent out based on one email sent
        var check_scheduled_emails_from_batch = function(batch_email_arr) {
          var all_scheduled_batch_ids = [];
          for (var i = 0 ; i < batch_email_arr.length; i ++) {

            current_email = batch_email_arr[i].email;

            payload = {
              key: MANDRILL_API_KEY,
              to: current_email
            }
            console.log('attempting', current_email, 'from batch', i);

            $.ajax({
              url: "https://mandrillapp.com/api/1.0/messages/list-scheduled.json",
              type: "POST",
              contentType: 'application/json',
              data: JSON.stringify(payload),
              success: function(scheduled_msgs){
                  if (scheduled_msgs.length > 0) {
                    all_scheduled_batch_ids.push(i);
                    batch_results_dict[i + ''].scheduled_emails = scheduled_msgs;
                    if (i === 12) {

                      create_scheduled_batch_table(all_scheduled_batch_ids, all_scheduled_batch_ids.length);
                    }
                  }
              }
            });

          }

        }

        // 1. get unique subjects
        // 2. get an email address with that subject, and look for messages sent in the past
        // 3. filter by templates
        // 4. get batch number, multiply it by size of dict from array 1

        getAllBatchStatistics();

    } );

batch_filter = {
      '1': {'date_from': '2015-03-24', date_to:'2015-03-26', start: 0, end:100},
      '2': {'date_from': '2015-03-24', date_to:'2015-03-26', start: 100, end:200},
      '3': {'date_from': '2015-03-24', date_to:'2015-03-26', start: 200, end:300},
      '4': {'date_from': '2015-03-24', date_to:'2015-03-26', start: 300, end:400},
      '5': {'date_from': '2015-03-24', date_to:'2015-03-26', start: 400, end:500},
      '6': {'date_from': '2015-03-24', date_to:'2015-03-26', start: 500, end:600},
      '7': {'date_from': '2015-03-24', date_to:'2015-03-26', start: 600, end:700},
      '8': {'date_from': '2015-03-27', date_to:'2015-03-28', start: 0, end:100},
      '9': {'date_from': '2015-03-27', date_to:'2015-03-28', start: 100, end:200},
      '10': {'date_from': '2015-03-27', date_to:'2015-03-28', start: 200, end:300},
      '11': {'date_from': '2015-03-27', date_to:'2015-03-28', start: 300, end:400},
      '12': {'date_from': '2015-03-27', date_to:'2015-03-28', start: 400, end:500}
    }

    var batch_filter_arr = ['hey-fname-i-have-a-question-for-you', 'uva-platform-10-free-access-code', 'uva-alert-new-jobs-for-20-hour', 'uva-alert-new-platform-launched', 'free-10-to-try-exclusive-uva-platform', 'hear-about-the-uva-kid-who-partied-too-hard', 'average-uva-work-study-12-this-one-is', 't8-hear-about-the-uva-kid-who-partied-too-hard', 't9-uva-it-s-like-cheating-but-we-encourage-i', 't10-frats-use-this-to-get-perfect-grades', 't11-perfect-grades-and-parties-at-the-same-damn', 't12-urgent-uva-students-needed-at-20-hour'];

    var processVirginiaEmailsMailgun = function(email_objs) {
      mandrill_result_format = [];
      for (var i = 0; i < email_objs.length; i ++) {
        email_obj = email_objs[i];
        if (email_obj.address) {
          info_dict = {
            email: email_obj.address
          }
          if (email_obj.name) {
            info_dict.name = email_obj.name.split(' ')[1];
          }
          mandrill_result_format.push(info_dict);
        }
      }
      return mandrill_result_format;
    }

    var postMandrillAPI = function(payload, is_test, num_emails) {
      if (! is_test) {
        payload.message.to = processVirginiaEmailsMailgun(next_hundred_emails);
        payload.message.metadata = {
          batch_size: next_hundred_emails.length,
          tags: payload.message.tags.join(" "),
          batch_campaign_id: 2,
          university: "virginia"
        }
      }

      $.ajax({
        url: "https://mandrillapp.com/api/1.0/messages/send-template.json",
        type: "POST",
        contentType: 'application/json',
        data: JSON.stringify(payload),
        success: function(response) {
          if (is_drip) {
            window.replace.location('/admin/campaigns/scheduled/');
          }
          if (! is_test && !is_drip) {
            deleteMailGunMembers(payload.message.to, 'virginia');
          } else {
            $('#test-email-success-modal').show();
          }
        },
        error: function(error) {
          alert(JSON.parse(error.responseText).message);
        }
      });

    }

    var searchMandrillMessage = function(query, date_from, date_to, start, end, callback, batch_id) {
          payload = {
            key: MANDRILL_API_KEY,
            date_from: date_from,
            date_to: date_to,
            limit: 1000
          }

          $.ajax({
            url: "https://mandrillapp.com/api/1.0/messages/search.json",
            type: "POST",
            contentType: 'application/json',
            data: JSON.stringify(payload),
            success: function(result) {
              if (callback) {
                callback(result.slice(start, end), batch_id);
              }
            }
          });
        }
</script>

{% endblock %}