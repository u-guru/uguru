{% extends 'new_admin/base.html' %}

{% block header_scripts %}
<link href="/static/new_admin/plugins/datatables/dataTables.bootstrap.css" rel="stylesheet" type="text/css" />
{% endblock %}

{% block content %}
 <!-- Content Wrapper. Contains page content -->
      <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <section class="content-header">
          <h1>
            View Bugs
            <br>
          </h1>
          <ol class="breadcrumb">
            <li><a href="/new_admin/"><i class="fa fa-dashboard"></i> Home </a></li>
            <li class="active">Bugs</li>
            <a class="btn btn-primary btn-xs pull-right" style="position: absolute;right: 10px;bottom: 4px;" href='/admin/bugs/'>
            <i class="fa fa-plus"></i>&nbsp;&nbsp;
                Create a Bug
            </a>
          </ol>
        </section>

        <!-- Main content -->
        <section class="content">


            <div class="box box-info box-solid">
                <div class="box-header with-border">
                  <h3 class="box-title">App Bugs</h3>
                  <div class="box-tools pull-right">
                    <button class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
                  </div><!-- /.box-tools -->
                </div><!-- /.box-header -->
                <div class="box-body table-responsive no-padding">
                    <table class="table table-hover bootstrap-database" id="view-app-bugs">

                    </table>
                </div><!-- /.box-body -->
            </div>

            <div class="box box-solid">
                <div class="box-header bg-olive with-border collapsed-box">
                  <h3 class="box-title">Dashboard Bugs</h3>
                  <div class="box-tools pull-right">
                    <button class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
                  </div><!-- /.box-tools -->
                </div><!-- /.box-header -->
                <div class="box-body table-responsive no-padding">
                    <table class="table table-hover bootstrap-database" id="view-dashboard-bugs">

                    </table>
                </div><!-- /.box-body -->
            </div>

            <div class="box box-warning box-solid collapsed-box">
                <div class="box-header with-border">
                  <h3 class="box-title">All Bugs</h3>
                  <div class="box-tools pull-right">
                    <button class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
                  </div><!-- /.box-tools -->
                </div><!-- /.box-header -->
                <div class="box-body table-responsive no-padding">
                    <table class="table table-hover bootstrap-database" id="view-all-issues">
                    </table>
                </div><!-- /.box-body -->
            </div>

        </section><!-- /.content -->
      </div><!-- /.content-wrapper -->
{% endblock %}

{% block footer_scripts %}
<script src="/static/js/new_admin/github_wrapper.js" type="text/javascript"></script>
<script src="/static/js/new_admin/github.js" type="text/javascript"></script>

<script>
    global_issues_dict = {};
    $(document).ready(function() {
        get_issues_gh_api(format_view_issues_gh_table);
    } );

    var process_issues_for_global_dict = function(issues_arr) {
        for (var k = 0; k < issues_arr.length; k++) {
            gh_issue_number = issues_arr[k].number;
            global_issues_dict[gh_issue_number + ''] = issues_arr[k];
        }
        console.log('global issue_dict', global_issues_dict);
    }

    var format_view_issues_gh_table = function(issues_arr) {

                var column_headers = ['#','Title', 'Contributor', 'Severity', 'Platform', 'Other', 'Action']
                var github_obj_column_keys = ['number', 'title', 'created_at'];

                //process this as well;
                global_issues_dict = process_issues_for_global_dict(issues_arr);


                //format all issues dropdown
                formatted_table_str = format_gh_issue_table(column_headers, github_obj_column_keys, issues_arr);

                $('#view-all-issues').append(formatted_table_str);

                // $('#view-all-issues').DataTable({
                //     "bInfo": false,
                //     "bPaginate": false,
                //     "bLengthChange": false,
                //     "bFilter": false,
                //     "aaSorting": [[0, 'desc']]
                // });

                // format app only issues issues dropdown
                filtered_issues = filter_issues_by_platform(issues_arr, "mobile");
                formatted_table_str = format_gh_issue_table(column_headers, github_obj_column_keys, filtered_issues);

                $('#view-app-bugs').append(formatted_table_str);


                //format dashboard only issues dropdown
                filtered_issues = filter_issues_by_platform(issues_arr, "dashboard");
                formatted_table_str = format_gh_issue_table(column_headers, github_obj_column_keys, filtered_issues);

                $('#view-dashboard-bugs').append(formatted_table_str);

        }

        var filter_issues_by_platform = function(issues_arr, platform) {
            mobile_platforms = ['ios', 'android', 'web'];
            dashboard_platforms = ['admin-dashboard']
            filtered_issues = [];

            for (var i = 0; i<issues_arr.length; i ++) {
                current_issue = issues_arr[i];
                label_str = process_issue_labels('platform', current_issue.labels);
                if (platform === 'mobile') {
                    for (var j = 0; j < mobile_platforms.length; j ++) {

                        mobile_platform_str = mobile_platforms[j];

                        if (label_str.indexOf(mobile_platform_str) !== -1) {
                            filtered_issues.push(current_issue);
                            break;
                        }

                    }

                }

                if (platform === 'dashboard') {
                    for (var j = 0; j < dashboard_platforms.length; j ++) {

                        dashboard_platforms_str = dashboard_platforms[j];

                        if (label_str.indexOf(dashboard_platforms_str) !== -1) {
                            filtered_issues.push(current_issue);
                            break;
                        }

                    }

                }

            }
            return filtered_issues;
        }

        var format_gh_issue_table = function(header_arr, column_keys_arr, issues_arr) {

            //create header
            result = "<thead></tr>"
            for (var i = 0; i < header_arr.length; i ++) {
                result += "<th>" + header_arr[i] + "</th>"
            }
            result += "</tr></thead>"


            result += '<tbody>'
            //generate body
            for (var j = 0; j < issues_arr.length; j++) {
                current_issue = issues_arr[j];
                current_issue_labels = current_issue.labels;
                one_row_str = '<tr>';
                for (var k = 0; k < header_arr.length; k ++) {
                    one_row_str += '<td>'
                    if (k < 2) {
                        current_key = column_keys_arr[k];
                        one_row_str += current_issue[current_key];
                    }
                    else
                    //platforms
                    if (k === 4) {
                        one_row_str += process_issue_labels('platform', current_issue_labels);
                    }
                    else
                    //severity
                    if (k === 3) {
                        one_row_str += process_issue_labels('severity', current_issue_labels);
                    }
                    else
                    //contributors
                    if (k === 2) {
                        one_row_str += process_issue_labels('contributor', current_issue_labels);
                    }
                    //labels
                    if (k === 5) {
                        one_row_str += process_issue_labels('other', current_issue_labels);
                    }
                    if (k === 6) {
                        one_row_str += '<i class="fa fa-edit"></i>'
                    }
                    one_row_str += '</td>';

                }
                one_row_str += '</tr>';
                result += one_row_str;

            }
            result += '</tbody>'
            return result;
        }

        var process_issue_labels = function(label_type, labels) {
            result_labels = [];
            result_str = '';
            for (var l = 0; l < labels.length; l++ ) {
                label = labels[l];
                if (label.name.split(':').length === 1 && label_type === 'other') {
                    result_labels.push(label.name);
                } else
                if (label.name.indexOf(label_type) !== -1) {
                    result_labels.push(label.name.split(':')[1]);
                }
            }


            // if (label_type === 'platform') {
            //     for (var i = 0; i < result_labels.length; i ++) {
            //         current_label = result_labels[i];
            //         if (current_label === 'ios') {
            //             result_str += '<i class="fa fa-apple"></i> ';
            //         }
            //         if (current_label === 'android') {
            //             result_str += '<i class="fa fa-android"></i> ';
            //         }
            //         if (current_label === 'web') {
            //             result_str += '<i class="fa fa-globe"></i> ';
            //         }
            //         if (current_label === 'admin-dashboard') {
            //             result_str += '<i class="fa fa-dash"></i> ';
            //         }
            //     }
            //     return result_str;
            // }
            return result_labels.join(' ');
        }

</script>

{% endblock %}