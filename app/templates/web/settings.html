{% extends 'web/base.html' %}
{% from 'web/macros/modals.html' import add_card_modal %}

{% block main_header %}
<header class="bar bar-nav">
  <h1 class="title">Settings</h1>
  <a class="btn btn-link pull-right" data-user-id='{{user.id}}' href="#" id='logout-link'>
        Logout
  </a>
</header>
{% endblock %}

{% block main_content %}
<div class="content should-hide-message-bar" data-user-id='{{user.id}}'>
  
  <div id='account-table' class='control-content setting-table active'>
    
    <h6 class="content-padded">Support</h6>
    <ul class="table-view">
      <li class="table-view-cell">
        <a class="navigate-right" data-transition='slide-in' href='/m/support/'>
            Questions, Issues, Refunds
        </a>
      </li>
    </ul>

    <h6 class="content-padded">My Profile & Details</h6>
    <ul class="table-view">
      <li class="table-view-cell">
        <a class="navigate-right" href='/m/profile/{{user.id}}/' data-transition='fade'>
          <div class="media-body">
            Edit My Profile
          </div>
        </a>
      </li>
      <li class="table-view-cell">
        <a class="navigate-right" href='/m/account_details/' data-transition='slide-in'>
            Account Details
        </a>
      </li>
    </ul>
    <h6 class="content-padded">Privacy Settings</h6>
    <ul class='table-view'>
      <li class="table-view-cell">
          Text Notifications
          <div id='text-toggle' class="toggle {% if user.text_notification %}active{%endif%}">
            <div class="toggle-handle"></div>
          </div>
      </li>
      <li class="table-view-cell">
          Email Notifications
          <div id='email-toggle' class="toggle {% if user.email_notification %}active{%endif%}">
            <div class="toggle-handle"></div>
          </div>
      </li>
      <li class="table-view-cell">
        <a class="navigate-right" href='/m/change_password/' data-transition='slide-in'>
          Change Password
        </a>
      </li>
    </ul>

    <h6 class="content-padded">Payment</h6>
    <ul class='table-view'>
      <li class="table-view-cell">
          <a class='navigate-right' href='/m/add_payment/' data-transition='slide-in'>
              Payments Card 
              {% if user.customer_id %}
              <p class='grey-text'>*{{user.customer_last4}}</p>
              {% endif %}
            <button class='btn btn-link green-shade-1 font-16'>
              {% if user.customer_id %}
              Edit
              {% else %}
              Add
              {% endif %}
            </button>
          </a>
      </li>
      {% if user.balance %}
      <li class="table-view-cell">
        <a class='navigate-right' href='/m/guru/cashout/' data-transition='slide-in'>
              Cashout Card 
              {% if user.recipient_id %}
              <p class='grey-text'>*{{user.recipient_last4}}</p>
              {% endif %}
            <button class='btn btn-link green-shade-1 font-16'>
              {% if user.recipient_last4 %}
              Edit
              {% else %}
              Add
              {% endif %}
            </button>
          </a>
      </li>
      {% endif %}
      {% if user.payments %}
      <li class="table-view-cell">
        <a class="navigate-right" href='/m/transactions' data-transition='slide-in'>
          View Transactions
        </a>
      </li>
      {% endif %}
    </ul>

  </div>

  <script>
  
    //Logout script
    $('#logout-link').click(function() {

      $.ajax({
            url: '/api/v1/logout',
            type: 'DELETE',
            contentType: 'application/json',
            success: function (request){
                window.PUSH({
                    transition : "fade",
                    url : "/m/welcome/"
                });
                return;
            },
            error: function (request) {
                alert(request.responseJSON['errors']);
            }
          });

    });



    //Toggle code to update notifications
    $('#text-toggle').on('toggle', function(){
        var is_on = $(this).hasClass('active');
        update_toggle('text-notification', is_on);
      });
    $('#email-toggle').on('toggle', function(){
        var is_on = $(this).hasClass('active');
        update_toggle('email-notification', is_on);
      });


    function update_toggle(setting_name, setting_value)  {
        
        var user_id = ($('.content').data().userId).toString();

        payload = JSON.stringify({
            update_attribute: setting_name,
            value: setting_value,
        });

        $.ajax({
            url: '/api/v1/users/' + user_id,
            type: 'PUT',
            contentType: 'application/json',
            data: payload,
            success: function (request){
                //no need to do anything
                return;
            },
            error: function (request) {
                alert(request.responseJSON['errors']);
            }
          });
      }

    </script>

  {% if not request.MOBILE %}
    <script>
      // Add desktop support for toggles
      // TODO: Create a macro that does this for 
      // all unsupported desktop inputs
      $('.toggle').on('click', function(){
          if ($(this).hasClass('active')) {
            $(this).removeClass('active');
          } else {
            $(this).addClass('active');
          }
      });

      $('#text-toggle').on('click', function(){
        var is_on = $(this).hasClass('active');
        update_toggle('text-notification', is_on);
      });

      $('#email-toggle').on('click', function(){
        var is_on = $(this).hasClass('active');
        update_toggle('email-notification', is_on);
      });      

    </script>
  {% endif %}
</div>
{% endblock %}
