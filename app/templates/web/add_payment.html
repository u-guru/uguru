{% extends 'web/base.html' %}

    {% block main_header %}
    <header class="bar bar-nav">
      {% if not user.customer_id %}
        <h1 class="title">Add Card</h1>
      {% else %}
        <h1 class="title">Add a New Card</h1>
      {% endif %}
      {% if redirect_request_id %}
        <a class="icon icon-left-nav pull-left" href="/m/confirm_request/{{redirect_request_id}}/" data-transition="slide-out"></a>  
      {% else %}
        <a class="icon icon-left-nav pull-left" href="/m/settings/" data-transition="slide-out"></a>
      {% endif %}
    </header>
    {% endblock %}

    {% block main_content %}
    <div class="content should-hide-tab-bar should-hide-message-bar">
      
      <ul class="table-view">
        <form class="input-group">
          <input id='card-num' type="text" placeholder="•••• •••• •••• ••••">
          <input id='exp-date' type="text" placeholder="MM / YYYY">
        </form>
      </ul>
      <a id='add-card-link' data-user-id='{{user.id}}' class="btn btn-positive btn-block">Submit</a>
      
    </div>    

      <script type="text/javascript">Stripe.setPublishableKey("{{stripe_key}}");</script>
      <script class='content-js'>
        
        function stripeAddCreditCardHandler(status, response) {

          if (response.error) {
                  // Show the errors on the form    
                  alert(response.error.message);
                  return;
              } else {
                  var token = response.id;
                  var data = {'add_card':token};
                  var user_id = ($('#add-card-link').data().userId).toString();
                  $.ajax({
                      type: "PUT",
                      contentType: 'application/json;charset=UTF-8',
                      url: '/api/v1/users/' +  user_id,
                      data: JSON.stringify(data),
                      dataType: "json", 
                      success: function(request){

                          url_components = window.location.pathname.split( '/' );
                          request_id = url_components[url_components.length - 2];

                          window.PUSH({
                              transition : "fade",
                              url : "/m/confirm_request/" + request_id + '/'
                          });
                          $('#add-card-modal').removeClass('active');
                          return;
                      },
                      error: function (request) {
                          alert(request.responseJSON['errors']);
                      }
                  });
              }
          }

        $(document).ready(function() {
          $('input#card-num').payment('formatCardNumber');
          $('input#exp-date').payment('formatCardExpiry');

          $('#add-card-link').on('click touchstart', function(){
            if (!$('input#card-num').val() || !$('input#exp-date').val()) {
                alert('Please enter all fields');
                return;
            }
            card_number  = $('input#card-num').val();
            expiration_date = $('input#exp-date').val();
            month = parseInt(expiration_date.split('/')[0], 10);
            year = parseInt(expiration_date.split('/')[1], 10);

            Stripe.card.createToken({
                number : card_number,
                exp_month : month,
                exp_year : year,
            }, stripeAddCreditCardHandler);

          });

        });
      </script>
  {% endblock %}

    
