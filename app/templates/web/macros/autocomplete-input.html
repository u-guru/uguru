
{% macro autocomplete_input(input_id) -%}

<script src="/static/js/jquery-2.1.1.min.js"></script>
<script src="/static/js/typeahead.bundle.js"></script>



<script>
  
  var courses = new Bloodhound({
    datumTokenizer: function(d) { return Bloodhound.tokenizers.whitespace(d.name); },
    queryTokenizer: Bloodhound.tokenizers.whitespace,
    limit: 5,
    prefetch: {
      url: '/static/data/autocomplete.json',
      filter: function(list) {
        return $.map(list, function(course) { return { name: course }; });
      }
    },
  });

  courses.initialize();
  
  // instantiate the typeahead UI
  $('#{{input_id}}').typeahead(
    {
      'highlight':true,
      'hint': false,
      'minLength':1
    },
    {
      displayKey: 'name',
      source: courses.ttAdapter()
    })
    .on('typeahead:selected', function() {
      if ($('#{{input_id}}').val()) {
        mixpanel.track("Request Form Course Selected", $('#{{input_id}}').val());
        $('#{{input_id}}').addClass('selected-course');
        $('#request-description').focus();
      }
    });
</script>
{%- endmacro %}

{% macro autocomplete_input_become_guru(input_id, course_list_div_id) -%}
  <script src="/static/js/jquery-2.1.1.min.js"></script>
  <script src="/static/js/typeahead.bundle.js"></script>

<script>
  
  autocomplete_json = JSON.parse(readJSON('/static/data/autocomplete.json'));

  var courses = new Bloodhound({
    datumTokenizer: function(d) { return Bloodhound.tokenizers.whitespace(d.name); },
    queryTokenizer: Bloodhound.tokenizers.whitespace,
    limit: 5,
    prefetch: {
      url: '/static/data/autocomplete.json',
      filter: function(list) {
        return $.map(list, function(course) { return { name: course }; });
      }
    },
  });

  courses.initialize();

  var all_courses_added = [];

  //Add a course to the list
  var add_course_to_list = function(course_name) {
    if (all_courses_added.indexOf(course_name) == 0) {
          all_courses_added.push(course_name);
        }

    //Make sure it exists in our list of courses
    if (autocomplete_json.indexOf(course_name) == -1) {
        alert('Please only add from the available options.');
        return;
    }

    mixpanel.track("Guru Skill Added", course_name);

    //update server
    update_skill_ajax('add',course_name);

    $('#{{course_list_div_id}}').append(
        '<span href="#" class="course-tag">' +
        course_name.toUpperCase() +'&nbsp;&nbsp;&nbsp;'
        + '<a class="remove-course"href="#">x</a></span>')
    $('#{{input_id}}').val('');

    if ($('.course-tag').length > 0) {
      $('#{{course_list_div_id}}').show();
    }

  };
  
  // instantiate the typeahead UI
  $('#{{input_id}}').typeahead(
    {
      'highlight':true,
      'hint': false,
      'minLength':1
    },
    {
      displayKey: 'name',
      source: courses.ttAdapter()
    })
    .on('typeahead:selected', function() {
      if ($('#{{input_id}}').val()) {
        var course_name = $('#{{input_id}}').val();
        add_course_to_list(course_name);
      }
    });

    //Add course input button is clicked
    $('#add-course-btn').click(function() {
      var course_name = $('#{{input_id}}').val();
      add_course_to_list(course_name);
    });

    //Remove any courses that want to be removed
    $('.content').on('click', 'a.remove-course', function() {
      
      //remove the x from the span
      var skill_name = $('a.remove-course').parent().text().slice(0, -1).trim();
      //remove the space

      update_skill_ajax('remove',skill_name);
      mixpanel.track("Guru Skill Removed", skill_name);
      
      //Remove & focus back on input
      $(this).parent().remove();
      $('#{{input_id}}').val('');
      $('#{{input_id}}').focus();
      
      if ($('.course-tag').length == 0) {
        $('#{{course_list_div_id}}').hide();
      }
    });

    //Update to server directly
    update_skill_ajax = function(add_or_remove, skill_name) {
      var data = {};
      if (add_or_remove == 'add') {
        data['add'] = skill_name;
      } else {
        data['remove'] = skill_name;
      }
      $.ajax({
        type: "POST",
        contentType: 'application/json;charset=UTF-8',
        url: '/update-skill/' ,
        data: JSON.stringify(data),
        dataType: "json"
      });
    };

    $('#{{input_id}}').keyup(function (e) {
      if (e.keyCode == 13 && $('#{{input_id}}').val()) {
        $('#add-course-btn').trigger('click');
        $('#{{input_id}}').val('');
      }
    });

    function readJSON(file) {
      var request = new XMLHttpRequest();
      request.open('GET', file, false);
      request.send(null);
      if (request.status == 200)
        return request.responseText;
    }

  </script>

{% endmacro %}